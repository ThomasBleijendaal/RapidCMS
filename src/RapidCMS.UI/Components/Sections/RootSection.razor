@inherits BaseRootSection

@if (!StateIsChanging)
{
    @if (CurrentNavigationState.PageType == PageType.Node)
    {
        <div class="content" @key=Update>
            @if (Sections == null || !Sections.Any())
            {
                <p>Loading..</p>
            }
            else
            {
                @foreach (var mainSection in Sections)
                {
                    var index = 0;

                    <CascadingEditContext EditContext=@mainSection.editContext>
                        <ButtonBar Buttons="Buttons" OnButtonClick="ButtonOnClickAsync" EditContext=@mainSection.editContext />

                        <EditContextStrayErrors />

                        @foreach (var section in mainSection.sections)
                        {
                            var renderFragment = section.ToRenderFragment();

                            if (renderFragment != null)
                            {
                                @renderFragment
                            }
                            else
                            {
                                <BlockSection Section="section" OnButtonClick="ButtonOnClickAsync" BlockNr="index++" />
                            }
                        }
                    </CascadingEditContext>
                }
            }
        </div>
    }
    else if (CurrentNavigationState.PageType == PageType.Collection)
    {
        @if (ListContext == null || ListUI == null || Sections == null)
        {
            <div class="content">
                <p>Loading..</p>
            </div>
        }
        else if (ListUI.ListType == ListType.Table)
        {
            <div class="content" @key=Update>
                            @*TODO: State="CurrentNavigationState"*@
                <CascadingEditContext EditContext=@ListContext.ProtoEditContext>
                    <Tabbar Tabs="Tabs"
                            SearchBarVisible="ListUI.SearchBarVisible"
                            OnSearch="SearchAsync"
                            OnTabChange="TabChangeAsync" />
                    <ButtonBar Buttons="Buttons" OnButtonClick="ListButtonOnClickAsync" EditContext=@ListContext.ProtoEditContext />
                </CascadingEditContext>
                @*TODO: CurrentState.CurrentPage"*@
                @*TODO: CurrentState.MaxPage"*@
                <TableSection UI="ListUI"
                              Sections="Sections"
                              CurrentPage="1" 
                              MaxPage="null" 
                              OnButtonClick="NodeButtonOnClickAsync"
                              OnRowDragged="OnRowDragged"
                              OnPageChanged="PageChangedAsync" />
            </div>
        }
        else if (ListUI.ListType == ListType.Block)
        {
            if (Buttons?.Any() == true)
            {
                <div class="content buttons-only">
                                @*TODO: State="CurrentState"*@
                    <CascadingEditContext EditContext=@ListContext.ProtoEditContext>
                        <Tabbar Tabs="Tabs"
                                SearchBarVisible="ListUI.SearchBarVisible"
                                OnSearch="SearchAsync"
                                OnTabChange="TabChangeAsync" />
                        <ButtonBar Buttons="Buttons" OnButtonClick="ListButtonOnClickAsync" EditContext=@ListContext.ProtoEditContext />
                    </CascadingEditContext>
                </div>
            }
            @*TODO: CurrentState.CurrentPage"*@
            @*TODO: CurrentState.MaxPage"*@
            <BlocksSection Sections="Sections"
                           CurrentPage="1" 
                           MaxPage="null" 
                           OnButtonClick="NodeButtonOnClickAsync"
                           OnPageChanged="PageChangedAsync" />
        }
    }
    else if ((CurrentNavigationState.PageType == PageType.Page || CurrentNavigationState.PageType == PageType.Dashboard) && PageContents != null)
    {
        <CascadingValue Name="Embedded" Value="true">
            @foreach (var section in PageContents)
            {
                @RenderType(section);
            }
        </CascadingValue>
    }
    else if (CurrentNavigationState.PageType == PageType.Unauthorized)
    {
        <UnauthorizedSection />
    }
    else if (CurrentNavigationState.PageType == PageType.Error)
    {
        <ErrorSection />
    }
}